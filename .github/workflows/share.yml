name: own share ubuntu Template

on:
  workflow_call:
    inputs:
      runs-on:
        description: 'Runner to use'
        required: false
        default: 'ubuntu-latest'
        type: string
    secrets:
      ZEROTIER_ID:
        required: true
      ZEROTIER_TOKEN:
        required: true
      CYM_TOKEN:
        required: true
      PHP_VERSION:
        required: true
      SWOOLE_VERSION:
        required: true
jobs:
  ubuntu-job:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v3

      - name: show user name
        run: |
          pwd
          ls -l
          whoami
          
      - name: show ubuntu version
        run: sudo cat /proc/version

      - name: install zerotier
        env:
          ZEROTIER_ID: ${{ secrets.ZEROTIER_ID }}
        run: |
          curl -s https://install.zerotier.com | sudo bash
          sudo zerotier-cli join "$ZEROTIER_ID"
          
      - name: install tcl tk expect
        run: |
          sudo apt install tcl tk expect
          
      - name:  middify root and runner user password
        run: |
          sh common/middify_password.sh
          ip addr
      - name:  complite swoole 
        run: |
          sh alpine317.sh ${{ secrets.PHP_VERSION }} ${{ secrets.SWOOLE_VERSION }}
      - name:  delete network
        if: always()
        env:
          ZEROTIER_ID: ${{ secrets.ZEROTIER_ID }}
          ZEROTIER_TOKEN: ${{ secrets.ZEROTIER_TOKEN }}
        run: |
          ip addr
          partial_name="ztrf"
          interfaces=$(ip addr show | grep -oP "(?<=: )$partial_name\S*")
          for interface in $interfaces; do
              ip_address=$(ip addr show $interface | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
          done
          url="https://api.zerotier.com/api/v1/network/$ZEROTIER_ID/member"
          json_response=$(curl -s -X GET -H "Authorization: token $ZEROTIER_TOKEN" "$url")
          echo "$json_response" | jq -c '.[]' | while read -r obj; do
              zero_ip=$(echo "$obj" | jq -r '.config.ipAssignments[0]')
              if [ "$ip_address" = "$zero_ip" ]; then
                  nodeId=$(echo "$obj" | jq -r '.nodeId')
                  urls="https://api.zerotier.com/api/v1/network/$ZEROTIER_ID/member/$nodeId"
                  json_response=$(curl -s -X DELETE -H "Authorization: token $ZEROTIER_TOKEN" "$urls")
                  echo $json_response
              else
                  echo "Strings are not equal"
              fi
          done
      - name: mv /mnt/swoole-cli-main317/*.tar.xz
        run: |
          ls -l /mnt/swoole-cli-main317/
          mkdir file
          mv /mnt/swoole-cli-main317/*.tar.xz file/
          echo "###--------------------------------------------###"
          ls -lh
          cd file && ls -lh
          echo "strDate=$(TZ=UTC-8 date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
      - name: Generate release notes
        run: |
          echo "### è‡ªåŠ¨æž„å»ºè¯¦æƒ… ðŸš€" > release_notes.md
          echo " " >> release_notes.md
          echo "è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç¼–è¯‘çš„ç‰ˆæœ¬ã€‚" >> release_notes.md
          echo " " >> release_notes.md
          echo "- **å¢žåŠ çš„æ‰©å±•:** ** inotify mongodb xlswriter" >> release_notes.md
          echo "- **è¿è¡Œå¹³å°:** ** ${{ inputs.runs-on }}" >> release_notes.md
          echo "- **ç¼–è¯‘æ—¶é—´:** ** ${{ env.strDate }}" >> release_notes.md
          echo "- **PHP ç‰ˆæœ¬:** ** ${{ secrets.PHP_VERSION }}" >> release_notes.md
          echo "- **Swoole ç‰ˆæœ¬:** ** ${{ secrets.SWOOLE_VERSION }}" >> release_notes.md
          
          # è°ƒè¯•ï¼šæ‰“å°æ–‡ä»¶å†…å®¹ï¼Œç¡®ä¿å®ƒè¢«æ­£ç¡®åˆ›å»º
          echo "--- (å¼€å§‹) release_notes.md å†…å®¹ ---"
          cat release_notes.md
          echo "--- (ç»“æŸ) release_notes.md å†…å®¹ ---"

      # æ­¥éª¤ 2: (æ–°å¢ž) å°†æ–‡ä»¶å†…å®¹è¯»å…¥ä¸€ä¸ªè¾“å‡ºå˜é‡
      - name: Read release notes body
        id: read_notes
        shell: bash
        run: |
          # è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ›¿æ¢æ¢è¡Œç¬¦ç­‰ï¼Œä½¿å…¶å¯ä»¥å®‰å…¨åœ°ä½œä¸ºå‚æ•°ä¼ é€’
          BODY_CONTENT=$(cat release_notes.md)
          BODY_CONTENT="${BODY_CONTENT//'%'/'%25'}"
          BODY_CONTENT="${BODY_CONTENT//$'\n'/'%0A'}"
          BODY_CONTENT="${BODY_CONTENT//$'\r'/'%0D'}"
          
          # å°†å†…å®¹è®¾ç½®ä¸º GitHub Actions çš„è¾“å‡º
          echo "body=$BODY_CONTENT" >> $GITHUB_OUTPUT
      - name: Upload release asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.CYM_TOKEN }}
          tag: ${{ env.strDate }}
          file_glob: true
          overwrite: true
          release_name: ${{ env.strDate }} - ${{ inputs.runs-on }} è‡ªåŠ¨å‘å¸ƒ PHP=>${{ secrets.PHP_VERSION }} Swoole=>${{ secrets.SWOOLE_VERSION }}
          file: file/*
          body: ${{ steps.read_notes.outputs.body }}
